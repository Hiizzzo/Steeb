name: iOS Release Build (Capacitor)

on:
  workflow_dispatch:
    inputs:
      upload_to_testflight:
        description: 'Upload IPA to TestFlight (requires ASC API secrets)'
        required: true
        default: 'false'
  push:
    tags:
      - 'ios-v*'

jobs:
  build-release:
    runs-on: macos-latest
    timeout-minutes: 90

    env:
      BUNDLE_ID: com.steeb.app
      TEAM_ID: ${{ secrets.TEAM_ID }}
      PROVISIONING_PROFILE_NAME: ${{ secrets.PROVISIONING_PROFILE_NAME }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build web assets
        run: npm run build

      - name: Install CocoaPods
        run: sudo gem install cocoapods --no-document

      - name: Add iOS platform and sync
        run: |
          npx cap add ios || true
          npx cap sync ios

      - name: Restore GoogleService-Info.plist from secret
        if: env.FIREBASE_PLIST_BASE64 != ''
        env:
          FIREBASE_PLIST_BASE64: ${{ secrets.FIREBASE_PLIST_BASE64 }}
        run: |
          mkdir -p ios/App/App
          echo "$FIREBASE_PLIST_BASE64" | base64 --decode > ios/App/App/GoogleService-Info.plist

      - name: Configure iOS URL Scheme from GoogleService-Info.plist (optional)
        if: env.FIREBASE_PLIST_BASE64 != ''
        run: |
          PLIST=ios/App/App/GoogleService-Info.plist
          INFO=ios/App/App/Info.plist
          if [ -f "$PLIST" ] && [ -f "$INFO" ]; then
            RCI=$(/usr/libexec/PlistBuddy -c "Print :REVERSED_CLIENT_ID" "$PLIST" || true)
            if [ -n "$RCI" ]; then
              /usr/libexec/PlistBuddy -c "Add :CFBundleURLTypes array" "$INFO" 2>/dev/null || true
              EXISTS=$( /usr/libexec/PlistBuddy -c "Print :CFBundleURLTypes" "$INFO" 2>/dev/null | grep -c "$RCI" || true )
              if [ "$EXISTS" = "0" ]; then
                /usr/libexec/PlistBuddy -c "Add :CFBundleURLTypes:0 dict" "$INFO" 2>/dev/null || true
                /usr/libexec/PlistBuddy -c "Add :CFBundleURLTypes:0:CFBundleURLSchemes array" "$INFO" 2>/dev/null || true
                /usr/libexec/PlistBuddy -c "Add :CFBundleURLTypes:0:CFBundleURLSchemes:0 string $RCI" "$INFO" 2>/dev/null || true
              fi
            fi
          fi

      - name: Pod install
        working-directory: ios/App
        run: pod install --repo-update

      - name: Create Keychain and Import Certificate
        env:
          CERT_P12_BASE64: ${{ secrets.CERT_P12_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
        run: |
          KEYCHAIN=build.keychain
          security create-keychain -p "" $KEYCHAIN
          security default-keychain -s $KEYCHAIN
          security unlock-keychain -p "" $KEYCHAIN
          security set-keychain-settings -lut 21600 $KEYCHAIN
          echo "$CERT_P12_BASE64" | base64 --decode > signing_cert.p12
          security import signing_cert.p12 -k $KEYCHAIN -P "$P12_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          security set-key-partition-list -S apple-tool:,apple: -s -k "" $KEYCHAIN

      - name: Install Provisioning Profile
        env:
          MOBILEPROVISION_BASE64: ${{ secrets.MOBILEPROVISION_BASE64 }}
          PROVISIONING_PROFILE_NAME: ${{ secrets.PROVISIONING_PROFILE_NAME }}
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "$MOBILEPROVISION_BASE64" | base64 --decode > "${PROVISIONING_PROFILE_NAME}.mobileprovision"
          uuid=$(grep -a -o '[-A-F0-9]\{36\}' "${PROVISIONING_PROFILE_NAME}.mobileprovision" | head -1)
          cp "${PROVISIONING_PROFILE_NAME}.mobileprovision" ~/Library/MobileDevice/Provisioning\ Profiles/$uuid.mobileprovision
          echo "PROFILE_UUID=$uuid" >> $GITHUB_ENV

      - name: Generate ExportOptions.plist
        run: |
          cat > ExportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store</string>
            <key>signingStyle</key>
            <string>manual</string>
            <key>uploadSymbols</key>
            <true/>
            <key>provisioningProfiles</key>
            <dict>
              <key>${BUNDLE_ID}</key>
              <string>${PROVISIONING_PROFILE_NAME}</string>
            </dict>
            <key>teamID</key>
            <string>${TEAM_ID}</string>
          </dict>
          </plist>
          EOF

      - name: Archive (xcodebuild)
        run: |
          xcodebuild -workspace ios/App/App.xcworkspace \
            -scheme App \
            -configuration Release \
            -archivePath build/App.xcarchive \
            PRODUCT_BUNDLE_IDENTIFIER=${BUNDLE_ID} \
            DEVELOPMENT_TEAM=${TEAM_ID} \
            CODE_SIGN_STYLE=Manual \
            PROVISIONING_PROFILE_SPECIFIER="${PROVISIONING_PROFILE_NAME}" \
            clean archive | xcpretty || exit ${PIPESTATUS[0]}

      - name: Export IPA
        run: |
          xcodebuild -exportArchive \
            -archivePath build/App.xcarchive \
            -exportOptionsPlist ExportOptions.plist \
            -exportPath build/export \
            -allowProvisioningUpdates | xcpretty || exit ${PIPESTATUS[0]}

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: build/export/*.ipa
          if-no-files-found: error

      - name: Prepare ASC API key (optional)
        if: ${{ github.event.inputs.upload_to_testflight == 'true' }}
        env:
          ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
          ASC_KEY_BASE64: ${{ secrets.ASC_KEY_BASE64 }}
        run: |
          if [ -z "$ASC_KEY_ID" ] || [ -z "$ASC_ISSUER_ID" ] || [ -z "$ASC_KEY_BASE64" ]; then
            echo "ASC API secrets not set; skipping upload." && exit 0
          fi
          echo "$ASC_KEY_BASE64" | base64 --decode > AuthKey_${ASC_KEY_ID}.p8

      - name: Install fastlane
        if: ${{ github.event.inputs.upload_to_testflight == 'true' }}
        run: sudo gem install fastlane --no-document

      - name: Create fastlane API key JSON
        if: ${{ github.event.inputs.upload_to_testflight == 'true' }}
        env:
          ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
        run: |
          cat > api_key.json <<JSON
          {
            "key_id": "${ASC_KEY_ID}",
            "issuer_id": "${ASC_ISSUER_ID}",
            "key": "$(cat AuthKey_${ASC_KEY_ID}.p8)",
            "in_house": false
          }
          JSON

      - name: Upload to TestFlight (fastlane pilot)
        if: ${{ github.event.inputs.upload_to_testflight == 'true' }}
        run: |
          fastlane pilot upload \
            --api_key_path api_key.json \
            --ipa build/export/*.ipa \
            --skip_waiting_for_build_processing true
